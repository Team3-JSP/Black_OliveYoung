<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.blackolive.app.mapper.store.StoreMapper">

	<select id="selectAllCity" resultType="com.blackolive.app.domain.store.CityDTO">
		SELECT *
		FROM city
	</select>
	
	<select id="selectAllDistrict" resultType="com.blackolive.app.domain.store.DistrictDTO">
		SELECT *
		FROM district
		WHERE city_id = #{city_id}
	</select>

	<select id="selectAllStore" resultType="StoreDTO">
		SELECT *
		FROM store s JOIN store_time st ON s.store_id = st.store_id
	</select>
	
	<select id="selectStoreList" resultType="StoreDTO">
		SELECT *
		FROM store s JOIN store_time st ON s.store_id = st.store_id
		<trim prefix="where" prefixOverrides="AND | OR">
			<if test="city != '' or district != ''">
				AND store_address LIKE '%' || #{city} || ' ' || #{district} || '%'
			</if>
			<trim prefix="AND (" prefixOverrides="OR" suffix=")">
				<if test="tcs != null and tcs != ''">
					OR s.store_id IN ( 
				        SELECT DISTINCT(store_id)
				        FROM handling_store
				        WHERE category_id IN (${tcs})
					)
				</if>
				<if test="pss != null and pss != ''">
					OR s.store_id IN (
				        SELECT DISTINCT(store_id)
				        FROM store_service
				        WHERE olive_service_id IN (${pss})
					)
				</if>
			</trim>
		</trim>
	</select>
	
	<update id="updateStoreFavorite">
		UPDATE store
		SET store_favorite = store_favorite + #{clickCheck}
		WHERE store_id = #{storeId}
	</update>
	
	<insert id="insertInterestShop">
		INSERT INTO interest_shop
		VALUES('AS_'||TO_CHAR(seq_inter_shop.NEXTVAL, 'FM00000000'), #{param1}, #{param2})
	</insert>
	
	<delete id="deleteInterestShop">
		DELETE FROM interest_shop
		WHERE user_id=#{param1} AND store_id=#{param2}
	</delete>
	
	<select id="selectInterestShop" resultType="StoreDTO">
		SELECT *
		FROM store s JOIN store_time st ON s.store_id = st.store_id
		JOIN interest_shop i ON s.store_id = i.store_id
		WHERE user_id = #{userId}
		<trim prefix="AND (" prefixOverrides="OR" suffix=")">
			<if test="tcs != null and tcs != ''">
				OR s.store_id IN ( 
					SELECT DISTINCT(store_id)
				    FROM handling_store
				    WHERE category_id IN (${tcs})
				)
			</if>
			<if test="pss != null and pss != ''">
				OR s.store_id IN (
					SELECT DISTINCT(store_id)
				    FROM store_service
				    WHERE olive_service_id IN (${pss})
				)
			</if>
		</trim>
		
	</select>
	
	<!-- <select id="selectStoreKeyword" resultType="StoreDTO">
		SELECT *
		FROM store s JOIN store_time st ON s.store_id = st.store_id
		WHERE store_address LIKE '%'||#{param1}||'%' OR store_name LIKE '%'||#{param1}||'%'
	</select> -->

	<select id="selectStoreKeyword" resultType="StoreDTO">
		SELECT *
		FROM store s JOIN store_time st ON s.store_id = st.store_id
		<trim prefix="where" prefixOverrides="AND | OR">
			<if test="keyword != ''">
				AND (store_address LIKE '%' || #{keyword}  ||'%' OR store_name LIKE '%' || #{keyword} || '%')
			</if>
			<trim prefix="AND (" prefixOverrides="OR" suffix=")">
				<if test="tcs != null and tcs != ''">
					OR s.store_id IN ( 
				        SELECT DISTINCT(store_id)
				        FROM handling_store
				        WHERE category_id IN (${tcs})
					)
				</if>
				<if test="pss != null and pss != ''">
					OR s.store_id IN (
				        SELECT DISTINCT(store_id)
				        FROM store_service
				        WHERE olive_service_id IN (${pss})
					)
				</if>
			</trim>
		</trim>
	</select>
	
	<select id="selectProductName" resultType="ProductContainer">
		SELECT *
		FROM productcontainer
		WHERE product_display_name LIKE '%' || #{keyword} || '%'
		ORDER BY LENGTH(product_display_name)
	</select>

</mapper>